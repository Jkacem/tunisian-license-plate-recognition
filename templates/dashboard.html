<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>License Plate Detection Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-subtle': 'bounce 2s infinite',
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .glassmorphism {
            backdrop-filter: blur(16px) saturate(180%);
            background-color: rgba(255, 255, 255, 0.75);
            border: 1px solid rgba(209, 213, 219, 0.3);
        }
        .dark-glassmorphism {
            backdrop-filter: blur(16px) saturate(180%);
            background-color: rgba(17, 24, 39, 0.8);
            border: 1px solid rgba(75, 85, 99, 0.3);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .status-indicator {
            position: relative;
        }
        .status-indicator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: -20px;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .status-running::before {
            background-color: #10b981;
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
        }
        .status-stopped::before {
            background-color: #ef4444;
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        }
        .plate-highlight {
            background: linear-gradient(45deg, #3b82f6, #1d4ed8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .table-row-hover {
            transition: all 0.2s ease-in-out;
        }
        .table-row-hover:hover {
            transform: translateX(4px);
            box-shadow: -4px 0 0 #3b82f6;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
    <!-- Background Pattern -->
    <div class="absolute inset-0 bg-[url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%239C92AC" fill-opacity="0.05"%3E%3Ccircle cx="30" cy="30" r="2"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E')] opacity-40"></div>
    
    <div class="relative z-10 min-h-screen p-4 md:p-8">
        <!-- Header -->
        <header class="glassmorphism rounded-2xl p-6 mb-8 shadow-2xl animate-fade-in">
            <div class="flex flex-col lg:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-car text-white text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl md:text-4xl font-bold text-white mb-1">
                            License Plate Detection
                        </h1>
                        <p class="text-gray-300 text-sm">Real-time vehicle monitoring system</p>
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <button id="startBtn" onclick="startDetection()" 
                            class="px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-semibold rounded-xl shadow-lg hover:from-green-600 hover:to-emerald-700 transform hover:scale-105 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
                        <i class="fas fa-play mr-2"></i>Start Detection
                    </button>
                    <button id="stopBtn" onclick="stopDetection()" disabled
                            class="px-6 py-3 bg-gradient-to-r from-red-500 to-rose-600 text-white font-semibold rounded-xl shadow-lg hover:from-red-600 hover:to-rose-700 transform hover:scale-105 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
                        <i class="fas fa-stop mr-2"></i>Stop Detection
                    </button>
                    <button onclick="location.reload()" 
                            class="px-4 py-3 bg-gradient-to-r from-gray-600 to-gray-700 text-white font-semibold rounded-xl shadow-lg hover:from-gray-700 hover:to-gray-800 transform hover:scale-105 transition-all duration-200">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Status Card -->
            <div class="glassmorphism rounded-2xl p-6 shadow-xl animate-fade-in">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-700">System Status</h3>
                    <i class="fas fa-heartbeat text-2xl text-purple-500"></i>
                </div>
                <p id="status" class="text-2xl font-bold text-gray-800 status-indicator pl-6">Loading...</p>
            </div>

            <!-- Total Detections Card -->
            <div class="glassmorphism rounded-2xl p-6 shadow-xl animate-fade-in" style="animation-delay: 0.1s">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-700">Total Detections</h3>
                    <i class="fas fa-chart-line text-2xl text-blue-500"></i>
                </div>
                <p id="totalDetections" class="text-3xl font-bold text-blue-600">-</p>
                <span class="text-sm text-gray-500">vehicles detected</span>
            </div>

            <!-- Last Detection Card -->
            <div class="glassmorphism rounded-2xl p-6 shadow-xl animate-fade-in" style="animation-delay: 0.2s">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-700">Last Detection</h3>
                    <i class="fas fa-clock text-2xl text-green-500"></i>
                </div>
                <p id="lastDetection" class="text-lg font-semibold text-gray-800">-</p>
                <span class="text-sm text-gray-500">most recent scan</span>
            </div>

            <!-- Records Count Card -->
            <div class="glassmorphism rounded-2xl p-6 shadow-xl animate-fade-in" style="animation-delay: 0.3s">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-700">Total Records</h3>
                    <i class="fas fa-database text-2xl text-orange-500"></i>
                </div>
                <p id="recordsCount" class="text-3xl font-bold text-orange-600">{{ plates|length }}</p>
                <span class="text-sm text-gray-500">stored records</span>
            </div>
        </div>

        <!-- Recent Detections Table -->
        <div class="glassmorphism rounded-2xl p-6 shadow-2xl animate-fade-in" style="animation-delay: 0.4s">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-list text-white"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Recent License Plates</h2>
            </div>

            <div class="overflow-hidden rounded-xl border border-gray-200">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <i class="fas fa-hashtag mr-2"></i>ID
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <i class="fas fa-car mr-2"></i>License Plate
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <i class="fas fa-tags mr-2"></i>Car Class
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <i class="fas fa-calendar-alt mr-2"></i>Timestamp
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="plateTableBody">
                            {% for record in plates %}
                            <tr class="table-row-hover hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">
                                    {{ record.id }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="text-xl font-bold plate-highlight">{{ record.plate_text }}</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                    {{ record.car_class }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                    <i class="fas fa-clock mr-2 text-gray-400"></i>
                                    {{ record.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            {% if not plates %}
            <div class="text-center py-12">
                <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                <p class="text-xl text-gray-500 mb-2">No license plates detected yet</p>
                <p class="text-gray-400">Start detection to begin monitoring vehicles</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Success/Error Toast -->
    <div id="toast" class="fixed top-4 right-4 z-50 transform translate-x-full transition-transform duration-300 ease-in-out">
        <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-4 max-w-sm border-l-4" id="toastContent">
            <div class="flex items-center">
                <div id="toastIcon" class="flex-shrink-0 w-5 h-5 mr-3"></div>
                <div id="toastMessage" class="text-sm font-medium text-gray-900 dark:text-white"></div>
            </div>
        </div>
    </div>

    <script>
        let statsInterval;
        let isDetectionRunning = false;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            statsInterval = setInterval(loadStats, 5000);
        });

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastContent = document.getElementById('toastContent');
            const toastIcon = document.getElementById('toastIcon');
            const toastMessage = document.getElementById('toastMessage');

            // Always reset toast visibility before showing
            toast.classList.add('translate-x-full');
            setTimeout(() => {
                // Set content
                toastMessage.textContent = message || 'Operation completed.';

                // Set styling based on type
                if (type === 'success') {
                    toastContent.className = 'bg-white shadow-lg rounded-lg p-4 max-w-sm border-l-4 border-green-400';
                    toastIcon.innerHTML = '<i class="fas fa-check-circle text-green-400"></i>';
                } else if (type === 'error') {
                    toastContent.className = 'bg-white shadow-lg rounded-lg p-4 max-w-sm border-l-4 border-red-400';
                    toastIcon.innerHTML = '<i class="fas fa-exclamation-circle text-red-400"></i>';
                }

                // Show toast
                toast.classList.remove('translate-x-full');

                // Hide toast after 3 seconds
                setTimeout(() => {
                    toast.classList.add('translate-x-full');
                }, 3000);
            }, 100);
        }

        function updateStatusDisplay(status) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = status;
            
            // Remove existing classes
            statusElement.classList.remove('status-running', 'status-stopped');
            
            // Add appropriate class
            if (status === 'Running') {
                statusElement.classList.add('status-running');
                isDetectionRunning = true;
            } else {
                statusElement.classList.add('status-stopped');
                isDetectionRunning = false;
            }
        }

        function loadStats() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    updateStatusDisplay(data.current_status);
                    document.getElementById('totalDetections').textContent = data.total_detections || 0;
                    
                    if (data.last_detection_time) {
                        const lastDetection = new Date(data.last_detection_time);
                        document.getElementById('lastDetection').textContent = lastDetection.toLocaleString();
                    } else {
                        document.getElementById('lastDetection').textContent = 'None yet';
                    }

                    // Update button states with smooth transitions
                    const startBtn = document.getElementById('startBtn');
                    const stopBtn = document.getElementById('stopBtn');
                    
                    if (data.current_status === 'Running') {
                        startBtn.disabled = true;
                        stopBtn.disabled = false;
                    } else {
                        startBtn.disabled = false;
                        stopBtn.disabled = true;
                    }
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                    updateStatusDisplay('Connection Error');
                });
        }

        async function startDetection() {
            const startBtn = document.getElementById('startBtn');
            startBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Starting...';
            startBtn.disabled = true;

            try {
                const response = await fetch('/api/start', { method: 'POST' });
                const data = await response.json();
                
                if (data.status === 'success') {
                    showToast('Detection started successfully!', 'success');
                    loadStats();
                } else {
                    showToast('Error: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error starting detection:', error);
                showToast('Error starting detection', 'error');
            } finally {
                startBtn.innerHTML = '<i class="fas fa-play mr-2"></i>Start Detection';
            }
        }

        async function stopDetection() {
            const stopBtn = document.getElementById('stopBtn');
            stopBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Stopping...';
            stopBtn.disabled = true;

            try {
                const response = await fetch('/api/stop', { method: 'POST' });
                const data = await response.json();
                
                if (data.status === 'success') {
                    showToast('Detection stopped successfully!', 'error'); // <-- Change 'success' to 'error' here
                    loadStats();
                } else {
                    showToast('Error: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error stopping detection', error);
                showToast('Error stopping detection', 'error');
            } finally {
                stopBtn.innerHTML = '<i class="fas fa-stop mr-2"></i>Stop Detection';
            }
        }

        // Handle visibility change to pause/resume updates
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                if (statsInterval) {
                    clearInterval(statsInterval);
                }
            } else {
                loadStats();
                statsInterval = setInterval(loadStats, 5000);
            }
        });

        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            if (statsInterval) {
                clearInterval(statsInterval);
            }
        });
    </script>
</body>
</html>